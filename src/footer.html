<div>
    Status: <span id="tunapanel_status"></span>
</div>

<script
    src="https://code.jquery.com/jquery-3.2.1.min.js"
    integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
    crossorigin="anonymous">
</script>

<style>
#tunapanel_status {
    font-weight: bold;
}

.tunapanel_success {
    color: #00ff00;
}

.tunapanel_failure {
    color: #ff0000;
}
</style>

<script>
$(function () {
    let conversions = {
        none:     function (elem) { return elem.value; },
        number:   function (elem) { return Number(elem.value); },
        checkbox: function (elem) { return elem.checked; }
    };

    function update_complete(jqxhr, status) {
        let elem = $("#tunapanel_status");
        elem.text(status);

        if (status === "success") {
            elem.attr("class", "tunapanel_success");
        } else {
            elem.attr("class", "tunapanel_failure");
        }
    }

    function update(button_name) {
        let obj = {};

        $(".tunapanel_widget").each(function (i, elem) {
            let name = elem.getAttribute('tunapanel_name');
            let conv = elem.getAttribute('tunapanel_conv');

            let value = conversions[conv](elem);
            obj[name] = value;
        });

        $(".tunapanel_button").each(function (i, elem) {
            let name = elem.getAttribute('tunapanel_name');
            obj[name] = (button_name === name);
        });

        $.ajax({
            url:      "/update",
            method:   "POST",
            data:     JSON.stringify(obj),
            complete: update_complete,
            timeout:  5000,
        });
    }

    $(".tunapanel_widget")
        .change(update)
        .keyup(update);

    $(".tunapanel_button").each(function (i, elem) {
        let name = elem.getAttribute('tunapanel_name');
        $(elem).click(function () {
            update(name);
        });
    });
});
</script>
